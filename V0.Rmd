---
title: "EA - Analisis OVNIs"
output: html_notebook
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Intro

En este projecto usaremos el fichero de datos "scrubbed.csv" obtenido en <https://www.kaggle.com/datasets/NUFORC/ufo-sightings>. Elimininaremos datos de tipo NA y cambiaremos paises vacios (i.e. pais == "") por "*Otros*". Tambien arreglamos el formato de los datos con la libreria *lubridate*. Usamos la libreria *dplyr* para eliminar columnas no necesarias.

```{r}
# Leemos datos de CSV
datos <- read.csv("scrubbed.csv")

# Reemplacamos paises "" por "Otros"
datos$country <- ifelse(datos$country=="","otros",datos$country)

# Formateamos datos
datos$datetime <- as.POSIXct(datos$datetime, format =  "%m/%d/%Y %H:%M")
datos$'duration (seconds)' <- as.integer(datos$'duration..seconds.')
datos$latitude <- as.numeric(datos$latitude)

# Eliminamos datos NA
datos <- na.omit(datos)

library(dplyr)

datos <- datos %>% select(-one_of('duration..seconds.', 'duration..hours.min.', 'date.posted'))
```

Analisando los datos por pais, podemos ver que la mayoria de los OVNIs reportados son en EEUU. Usaremos la libreria *ggplot2* para generar un diagrama representando el numero de OVNIs reportados por pais.

```{r}
by_country <- aggregate(datos$country, by=list(Country = datos$country), FUN=length)

library(ggplot2)

ggplot(by_country, aes(x=by_country$Country, y=by_country$x, fill=by_country$Country)) +
  geom_bar(stat="identity", width=1) +
  xlab('Paises') +
  ylab('Avistamientos') +
  guides(fill = guide_legend(title = "Country" ))
```

Por eso, hemos decidido hacer nuestros analisis sobre datos solamente de EEUU. Tomamos una prueba de tamaño 1000.

```{r}
datos_us <- datos[which(datos$country == 'us'),]

datos_us <- datos_us %>% select(-country)

datos_us <- datos_us[sample(nrow(datos_us), 1000), ]
```


# Tema 3 - Estadística Descriptiva y Regresión (Axel)
De la prueba de 1000 datos, se ha hecho el análisis solamente de las variables cuantitativas, las cuales son: ("datetime, latitude, longitude, duration(seconds)").

Con el comando names(object...) se puede ver todas las columnas del fichero de datos y las referenciadas anteriormente.
```{r}
names(datos_us)
```


## Medidas de Posición - Tendencia Central y No Central

Con `summary(object...)` podemos ver la media, mediana y percentiles de varios datos, para calcular la moda usamos la funcion *mode*.

```{r}
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```


### datetime
```{r}
summary(datos_us$datetime)

print(paste("Moda: ", mode(datos_us$datetime)))
```
### latitude
```{r}
summary(datos_us$latitude)

print(paste("Moda: ", mode(datos_us$latitude)))
```
### longitude
```{r}
summary(datos_us$longitude)

print(paste("Moda: ", mode(datos_us$longitude)))
```
### duration (seconds)
```{r}
summary(datos_us$'duration (seconds)')

print(paste("Moda: ", mode(datos_us$'duration (seconds)')))
```

## Medidas de Dispersión

No se ha considerado necesario calcular la varianza y desviación poblacional

| Medida | Formula |
|:------|-------:|
| Cuasivarianza | var(x) |
| Cuasidesviación típica | sd(x) |
| Coeficiente de variación | coef_var(x) |

```{r}
coef_var <- function(x) {
  sd(x) / mean(x)
}
```

### duration (seconds)
```{r}
varianza <- var(datos_us$'duration (seconds)')
print(paste("Cuasivarianza: ", varianza))

sd <- sd(datos_us$'duration (seconds)')
print(paste("Cuasidesviación típica: ", sd))

cv <- coef_var(datos_us$'duration (seconds)')
print(paste("Coeficiente de variación: ", cv))

```
### latitude
```{r}
varianza <- var(datos_us$latitude)
print(paste("Cuasivarianza: ", varianza))

sd <- sd(datos_us$latitude)
print(paste("Cuasidesviación típica: ", sd))

cv <- coef_var(datos_us$latitude)
print(paste("Coeficiente de variación: ", cv))

```
### longitude
```{r}
varianza <- var(datos_us$longitude)
print(paste("Cuasivarianza: ", varianza))

sd <- sd(datos_us$longitude)
print(paste("Cuasidesviación típica: ", sd))

cv <- coef_var(datos_us$longitude)
print(paste("Coeficiente de variación: ", cv))

```
### datetime
Como no se pueden dividir fechas, no calculamos el *Coeficiente de variación* para datetime.

```{r}
varianza <- var(datos_us$datetime)
print(paste("Cuasivarianza: ", varianza))

sd <- sd(datos_us$datetime)
print(paste("Cuasidesviación típica: ", sd))
```
## Medidas de Forma
### latitude
Al calcular la asimetría y curtosis de la latitud determinamos que:
*Obtenemos una asimetría negativa, por tanto la mayoría de datos se encuentran a la derecha de la media.
*Obtenemos una curtosis mayor que cero, por tanto, hay una mayor concentración
de datos alrededor de la media
```{r}
library(moments)
x <- (datos_us$latitude)
print(kurtosis(x))
print(skewness(x))
print(mean(x))
hist(x)
```
### longitude
Al calcular la asimetría y curtosis de la latitud determinamos que:
*Obtenemos una asimetría negativa, por tanto la mayoría de datos se encuentran a la derecha de la media.
*Obtenemos una curtosis mayor que cero, por tanto, hay una mayor concentración
de datos alrededor de la media
```{r}
library(moments)
x <- (datos_us$longitude)
print(kurtosis(x))
print(skewness(x))
print(mean(x))
hist(x)
```
### datetime
Al calcular la asimetría y curtosis de la latitud determinamos que:
*Obtenemos una asimetría negativa, por tanto la mayoría de datos se encuentran a la derecha de la media.
*Obtenemos una curtosis mayor que cero, por tanto, hay una mayor concentración
de datos alrededor de la media
```{r}
library(moments)
x <- (datos_us$datetime)
print(kurtosis(x))
print(skewness(x))
hist(x, 50)
```
### duration (seconds)
Al calcular la asimetría y curtosis de la latitud determinamos que:
*Obtenemos una asimetría positiva, por tanto la mayoría de datos se encuentran a la izquierda de la media.
*Obtenemos una curtosis mayor que cero, por tanto, hay una mayor concentración
de datos alrededor de la media
```{r}
library(moments)
x <- (datos_us$'duration (seconds)')
print(kurtosis(x))
print(skewness(x))
print(mean(x))
```
## Gráficos 
Asociados a la Tabla de Frecuencias para algunos datos (excepto histogramas, usados anteriormente para ver mejor las medidas de forma)
### latitud
```{r}
breaks <- seq(0, 90, by=10)
lat.cumfreq <- c(0,cumsum(table(cut(datos_us$latitude, breaks, right = FALSE))))

plot(breaks, lat.cumfreq,
     main="Latitud de los ovnis",
     xlab = "Latitud",
     ylab = "Latitudes acumuladas")
lines(breaks, lat.cumfreq)
```
### longitude
```{r}
breaks <- seq(-200, 100, by=10)
longitude.cumfreq <- c(0,cumsum(table(cut(datos_us$longitude, breaks, right = FALSE))))
plot(breaks, longitude.cumfreq,
     main="Longitud de los ovnis",
     xlab = "Longitud",
     ylab = "Longitudes acumuladas")
lines(breaks, longitude.cumfreq)
```

# Tema 4 - Probabilidad (Fonsi)

Si quieres tratar de avistar un UFO la siguiente información que te proporcionamos te será de suma utilidad, como el pais, estado y ciudad donde debes ir para realizar un avistamiento, además de la forma que debes buscar y las horas a las que debes buscarlo, además de otros datos curiosos como la duración y los años que fueron más probables de avistar.

```{r}
dat <- read.csv("scrubbed.csv")
dat_country<-aggregate(dat$country, by=list(Country = dat$country), FUN=length)
dat$country <- ifelse(dat$country=="","otros",dat$country)
numAvistamientos<-sum(dat_country$x)
proobau1<-dat_country[which(dat_country$Country == 'au'),]
proobau2<-dat_country[which(dat_country$Country == 'ca'),]
proobau3<-dat_country[which(dat_country$Country == 'de'),]
proobau4<-dat_country[which(dat_country$Country == 'gb'),]
proobau5<-dat_country[which(dat_country$Country == 'us'),]
proobau6<-dat_country[which(dat_country$Country == ''),]
probbauval1<-(proobau1$x/numAvistamientos)*100
probbauval2<-(proobau2$x/numAvistamientos)*100
probbauval3<-(proobau3$x/numAvistamientos)*100
probbauval4<-(proobau4$x/numAvistamientos)*100
probbauval5<-(proobau5$x/numAvistamientos)*100
probbauval6<-(proobau6$x/numAvistamientos)*100

maxcountry<-sum(by_country$x)


ggplot(by_country, aes(x=Country, y=(x/maxcountry)*100, fill=Country)) +
  geom_bar(stat="identity", width=1) +
  xlab('Paises') +
  ylab('Probabilidad') +
  guides(fill = guide_legend(title = "Country" ))


print(paste("La probabilidad de avistar un ovni en Australia es del: ",probbauval1,"%"))

print(paste("La probabilidad de avistar un ovni en Canadá es del: ",probbauval2,"%"))

print(paste("La probabilidad de avistar un ovni en Alemania es del: ",probbauval3,"%"))

print(paste("La probabilidad de avistar un ovni en Gran Bretaña es del: ",probbauval4,"%"))

print(paste("La probabilidad de avistar un ovni en Estados Unidos es del: ",probbauval5,"%"))

print(paste("La probabilidad de avistar un ovni en otros países es del: ",probbauval6,"%"))
```

Debido a que es  en Estados Unidos donde hay mayor probabilidad de avistar un UFO vamos a calcular los estados donde es mas probable lograrlo


```{r}
datos <- read.csv("scrubbed.csv")
datos$state <- ifelse(datos$state=="","otros",datos$state)
datos_usProbstate <- datos[which(datos$country == 'us'),]

datos_usProbstate <- datos %>% select(-country)

datos_usProbstate <- datos[sample(nrow(datos_us), 1000), ]

by_stateProb <- aggregate(datos_usProbstate$state, by=list(State = datos_usProbstate$state), FUN=length)

avistTot<-sum(by_stateProb$x)
mostseekstate<-by_stateProb[which(by_stateProb$x>16),]

maxstate<-by_stateProb[which(by_stateProb$x == max(by_stateProb$x)),]
print(paste("El estado con mayor probabilidad de avistar un ovni es",maxstate$State,"con una probabilidad de un ",(maxstate$x/avistTot)*100,"%"))
print(paste("A continuación se muestra una gráfica con los estados donde mayor probabilidad hay de avistar un ovni"))

ggplot(mostseekstate, aes(x=mostseekstate$State, y=(mostseekstate$x/avistTot)*100, fill=mostseekstate$State)) +
  geom_bar(stat="identity", width=1) +
  xlab('') +
  ylab('Probabilidad') +
  theme(axis.text.x=element_blank())+
  guides(fill = guide_legend(title = "Estados" ))

```
Ya que hemos calculado los estados haremos lo mismo con las ciudades

```{r}
datos <- read.csv("scrubbed.csv")

datos_usProb <- datos[which(datos$country == 'us'),]

datos_usProb <- datos %>% select(-country)

datos_usProb <- datos[sample(nrow(datos_us), 1000), ]

by_cityProb <- aggregate(datos_usProb$city, by=list(City = datos_usProb$city), FUN=length)

avistTot<-sum(by_cityProb$x)
mostseek<-by_cityProb[which(by_cityProb$x>4),]

maxcity<-by_cityProb[which(by_cityProb$x == max(by_cityProb$x)),]
print(paste("La ciudad con mayor probabilidad de avistar un ovni es",maxcity$City,"con una probabilidad de un ",(maxcity$x/avistTot)*100,"%"))
print(paste("A continuación se muestra una gráfica con las ciudades donde mayor probabilidad hay de avistar un ovni"))
ggplot(mostseek, aes(x=City, y=(x/avistTot)*100, fill=City)) +
  geom_bar(stat="identity", width=1) +
  xlab('') +
  ylab('Probabilidad') +
  theme(axis.text.x=element_blank())+
  guides(fill = guide_legend(title = "Ciudades" ))

```



En cuanto a la forma que tienes que buscar en el cielo para lograr un avistamiento exitoso
```{r}
by_shape <- aggregate(datos_us$shape, by=list(shape = datos_us$shape), FUN=length)
by_shape$shape <- ifelse(by_shape$shape=="","otros",by_shape$shape)

max_shape<-sum(by_shape$x)
maxshape<-by_shape[which(by_shape$x == max(by_shape$x)),]
minshape<-by_shape[which(by_shape$x == min(by_shape$x)),]
print(paste("El ovni mas probabilidad de ser avistado son aquellos ovnis con forma",maxshape$shape,"con una probabilidad del",(maxshape$x/avistTot)*100,"%"))
print(paste("Mientras que los más raros con mayor dificultad de avistamiento son aquellos con forma"))
print (paste(minshape$shape))
print(paste("con una probabilidad de avistamiento del",(minshape$x[1]/avistTot)*100,"%"))

ggplot(by_shape, aes(x=by_shape$shape,y=(by_shape$x/max_shape)*100,fill=by_shape$shape)) +
  geom_bar(stat="identity", width=1) +
  xlab('') +
  ylab('Avistamientos') +
theme(axis.text.x=element_blank())+
  guides(fill = guide_legend(title = "Formas" ))


```
La hora también es importante, hay que saber cuando buscar y cuando descansar
```{r}
by_horas<- aggregate(datos_us$datetime, by=list(Hour = format(datos_us$datetime,"%H")), FUN=length)
maxhora<-by_horas[which(by_horas$x == max(by_horas$x)),]
maxhour<-sum(by_horas$x)
print(paste("La hora en la que es más probable avistar un ovni son las",maxhora$Hour,':00',"con una probabilidad del",(maxhora$x/avistTot)*100,"%"))
plot(by_horas$Hour,(by_horas$x/maxhour)*100,type="s",col="dark red", xlab = "Horas del día", ylab = "Probabilidad", main = "Probabilidad de avistamiento por hora")
```

También es interesante ver cuando hubo una mayor probabilidad de avistar un ovni
```{r}
anios<- aggregate(datos_us$datetime, by=list(Date = format(datos_us$datetime,"%Y")), FUN=length)

maxanio<-anios[which(anios$x == max(anios$x)),]
maxyear<-sum(anios$x)
print(paste("El año con mayor probabilidad en caso de avistamiento fué",maxanio$Date,"con una probabilidad del",(maxanio$x/avistTot)*100,"%"))
plot(anios$Date,(anios$x/maxyear)*100,type="l",col="dark blue", xlab = "Linea temporal", ylab = "Probabilidad", main = "Probabilidad de avistamientos por año")
```
Para finalizar observamos la probabilidad de lograr un avistamiento de larga duración
```{r}
durability<- aggregate(datos_us$`duration (seconds)`, by=list(duracion = datos_us$`duration (seconds)`), FUN=length)
                       
maxdur<-durability[which(durability$x>1),]
maxdur3<-durability[which(durability$x<=60),]
maxdur2<-durability[which(durability$x<=10),]
maxdur4<-durability[which(durability$x>60),]
sumaprobduracion<-sum(durability$x)
sumaprobduracion2<-sum(maxdur2$x)
sumaprobduracion3<-sum(maxdur3$x)
sumaprobduracion4<-sum(maxdur4$x)

print(paste("La probabilidad de ver un UFO durante menos de 10 segundos es del",(sumaprobduracion2/sumaprobduracion)*100,"%"))
print(paste("La probabilidad de ver un UFO durante menos de un minuto es del",(sumaprobduracion3/sumaprobduracion)*100,"%"))
print(paste("La probabilidad de ver un UFO durante mas de un minuto es del",(sumaprobduracion4/sumaprobduracion)*100,"%"))
plot(maxdur$duracion,(maxdur$x/sumaprobduracion)*100,type="l",col="blue", xlab = "Segundos", ylab = "Probabilidad", main = "Probabilidad de avistamientos por más de un segundo")
```
# TODO (FONSI)
### Operaciones con Sucesos
### Probabilidad Condicionada

# Tema 5 - Variables Aleatorias y Modelos de Probabilidad (Sergio)

# Tema 6 - Muestreo, Estimación Puntual y por Intervalos de Confianza (Iñigo)

Vamos a construir un intervalo de confianza del 95% para la duracion media de los avistamientos en EEUU.
```{r}
#filtramos por duracion menor o igual a 7200, para descartar valores muy altos que son inútiles en nuestro análisis
retval <- subset(datos_us, datos_us$`duration (seconds)` < 7201, select = c(state, `duration (seconds)`))

intervalo <- t.test(retval$'duration (seconds)', conf.level = 0.95)#sacamos el intervalo de confianza
print(intervalo$conf.int)#intervalo de confianza
print(mean(retval$'duration (seconds)'))#media

print(paste("El resultado indica que la media de la variable duracion (seconds) es de ", mean(retval$duration..seconds.), " el cual se encuentra con una confianza del 95% en el intervalo ", intervalo$conf.int[1], " ", intervalo$conf.int[2]))

car::qqPlot(retval$'duration (seconds)', pch=19,
       main='QQplot para la duración de avistamientos',
       xlab='Cuantiles teóricos',
       ylab='Cuantiles muestrales')

hist(retval$'duration (seconds)', freq=TRUE,
     main='Histograma para la duración de avistamientos',
     xlab='Duracion (s)',
     ylab='Frecuencia')
     #Podemos observar que la mayoría de avistamientos duran muy poco tiempo.
```


# Tema 7 - Contrastes de Hipótesis (Nico)
